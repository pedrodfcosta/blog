<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>Testing Gulp Tasks | Snugug</title><link rel="icon" href="/images/favicon.png"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="google-site-verification" content="zIeV2B7zZKCtEFP-6vV8rKk0ocpbp035v_g3IRn12Jo"><script src="/js/main.js" defer="defer"></script><style type="text/css">article,body,div,h1,header,html,main{background:0 0;border:0;font-size:100%;margin:0;outline:0;padding:0;vertical-align:baseline}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{line-height:1}article,header,main{display:block}html{box-sizing:border-box}*,:after,:before{box-sizing:inherit}:root{font-size:125%;font-family:aller,'Lucida Grande','Lucida Sans Unicode','Lucida Sans',Geneva,Verdana,sans-serif}body{background:#f8f7f2;color:#2c2a21;text-rendering:optimizeLegibility;-webkit-font-feature-settings:"liga","dlig";-ms-font-feature-settings:"liga","dlig";-o-font-feature-settings:"liga","dlig";font-feature-settings:"liga","dlig";font-weight:400}body *+*{margin-top:1rem}.article--heading{width:100vw;padding:2rem;display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;z-index:-1}.article--heading{background-color:#c20030;background:linear-gradient(0deg,rgba(194,0,48,0) 10%,rgba(194,0,48,.05) 10%,rgba(194,0,48,.05) 20%,rgba(194,0,48,.1) 20%,rgba(194,0,48,.1) 30%,rgba(194,0,48,.15) 30%,rgba(194,0,48,.15) 40%,rgba(194,0,48,.2) 40%,rgba(194,0,48,.2) 50%,rgba(194,0,48,.3) 50%,rgba(194,0,48,.3) 60%,rgba(194,0,48,.4) 60%,rgba(194,0,48,.4) 70%,rgba(194,0,48,.5) 70%,rgba(194,0,48,.5) 80%,rgba(194,0,48,.6) 80%,rgba(194,0,48,.6) 90%,rgba(194,0,48,.8) 90%),linear-gradient(-90deg,rgba(194,0,48,0) 10%,rgba(194,0,48,.05) 10%,rgba(194,0,48,.05) 20%,rgba(194,0,48,.1) 20%,rgba(194,0,48,.1) 30%,rgba(194,0,48,.15) 30%,rgba(194,0,48,.15) 40%,rgba(194,0,48,.2) 40%,rgba(194,0,48,.2) 50%,rgba(194,0,48,.3) 50%,rgba(194,0,48,.3) 60%,rgba(194,0,48,.4) 60%,rgba(194,0,48,.4) 70%,rgba(194,0,48,.5) 70%,rgba(194,0,48,.5) 80%,rgba(194,0,48,.6) 80%,rgba(194,0,48,.6) 90%,rgba(194,0,48,.8) 90%),#da9400;min-height:100vh}.article--title{text-shadow:0 -.005em #111,-.005em 0 #282727,-.005em -.01em #111,-.01em -.005em #282727,-.01em -.015em #111,-.015em -.01em #282727,-.015em -.02em #111,-.02em -.015em #282727,-.02em -.025em #111,-.025em -.02em #282727,-.025em -.03em #111,-.03em -.025em #282727,-.03em -.035em #111,-.035em -.03em #282727,-.035em -.04em #111,-.04em -.035em #282727,-.04em -.045em #111,-.045em -.04em #282727,-.045em -.05em #111,-.05em -.045em #282727,-.05em -.055em #111,-.055em -.05em #282727,-.055em -.06em #111,-.06em -.055em #282727,-.06em -.065em #111,-.065em -.06em #282727,-.065em -.07em #111,-.07em -.065em #282727,-.07em -.075em #111,-.075em -.07em #282727;-webkit-font-feature-settings:"liga","dlig";-ms-font-feature-settings:"liga","dlig";-o-font-feature-settings:"liga","dlig";font-feature-settings:"liga","dlig";color:#f8f7f2;font-size:2rem;font-weight:700;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto;line-height:1.2;margin-right:0;margin:0 auto;max-width:100%;text-align:right;text-rendering:optimizeLegibility;word-wrap:break-word}@media (min-width:860px){.article--title{font-size:6vw;margin-right:calc(10% - 2rem);max-width:80%}}._blog{margin-top:0}@supports (display:flex){._blog{display:-ms-flexbox;display:flex;min-height:100vh;-ms-flex-direction:column;flex-direction:column}}@supports (display:flex){._blog--article{-ms-flex:1;flex:1}}</style><link rel="preload" href="/css/style.css" as="style" onload="this.rel='stylesheet'"><noscript><link rel="stylesheet" href="/css/style.css"></noscript><script>!function(u){"use strict";var e=function(e,t,n){var r,o=u.document,a=o.createElement("link");if(t)r=t;else{var l=(o.body||o.getElementsByTagName("head")[0]).childNodes;r=l[l.length-1]}var i=o.styleSheets;a.rel="stylesheet",a.href=e,a.media="only x",function e(t){if(o.body)return t();setTimeout(function(){e(t)})}(function(){r.parentNode.insertBefore(a,t?r:r.nextSibling)});var d=function(e){for(var t=a.href,n=i.length;n--;)if(i[n].href===t)return e();setTimeout(function(){d(e)})};function s(){a.addEventListener&&a.removeEventListener("load",s),a.media=n||"all"}return a.addEventListener&&a.addEventListener("load",s),(a.onloadcssdefined=d)(s),a};"undefined"!=typeof exports?exports.loadCSS=e:u.loadCSS=e}("undefined"!=typeof global?global:this),function(r){if(r.loadCSS){var e=loadCSS.relpreload={};if(e.support=function(){try{return r.document.createElement("link").relList.supports("preload")}catch(e){return!1}},e.poly=function(){for(var e=r.document.getElementsByTagName("link"),t=0;t<e.length;t++){var n=e[t];"preload"===n.rel&&"style"===n.getAttribute("as")&&(r.loadCSS(n.href,n,n.getAttribute("media")),n.rel=null)}},!e.support()){e.poly();var t=r.setInterval(e.poly,300);r.addEventListener&&r.addEventListener("load",function(){e.poly(),r.clearInterval(t)}),r.attachEvent&&r.attachEvent("onload",function(){r.clearInterval(t)})}}}(this);</script><script id="font-load">(function () {
      'use strict';

      var fontURL = '/css/fonts.css?bust=342918',
          fonts,
          req,
          style,
          fontUrlLS;

      window.domCL = false;

      window.addEventListener('DOMContentLoaded', function () {
        window.domCL = true;
      });

      if (window.localStorage && document.querySelector && window.XMLHttpRequest) {
        fonts = localStorage.getItem('fonts');
        fontUrlLS = localStorage.getItem('fontURL');

        if (fonts && fontUrlLS === fontURL) {
          req = document.querySelector('#font-load');

          style = window.document.createElement('style');
          style.innerHTML = fonts;

          req.parentNode.insertBefore(style, req.nextSibling);
        }
        else {
          window.addEventListener('load', function () {
            req = new XMLHttpRequest();
            req.open('GET', fontURL);
            req.onreadystatechange = function () {
              localStorage.setItem('fonts', req.responseText);
              localStorage.setItem('fontURL', fontURL);
            }
            req.send();
          });
        }
      }
    })();</script></head><body><div class="_blog"><main class="_blog--article" itemscope="" itemtype="http://schema.org/Blog"><article class="article"><header class="article--heading"><h1 class="article--title" itemprop="name">Testing Gulp Tasks</h1></header><div class="article--content base" itemprop="text"><p>I recently started rewriting my static site generator <a href="https://github.com/snugug/gulp-armadillo">Armadillo</a> and had a dilemma; the current version of Armadillo could only be tested manually because I didn't have good way of automating my tests. Now, in order to accomplish things like continuous integration and delivery, and be able to automatically roll semantic releases, this wasn't good enough. So, I went in search of a way to test Gulp tasks, and my search, well, wasn't great. Pretty much everyone recommended calling the task from the command line, which seemed a bit heavy-handed for me. I think, however, I've figured out a better way.</p><h2>Rethinking a Gulp Task</h2><p>Let's take a look at a typical Gulp task:</p><pre class="language-javascript"><code class="language-javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> gulp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> sass <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sass'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> eyeglass <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'eyeglass'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> prefix <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-autoprefixer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> lint <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-sass-lint'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> sourcemaps <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-sourcemaps'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'sass'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> gulp<span class="token punctuation">.</span><span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'sass/**/*.scss'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">lint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>sourcemaps<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">sass</span><span class="token punctuation">(</span><span class="token function">eyeglass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">prefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>sourcemaps<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'./maps'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'./css'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>This Gulp task reads in all <code>.scss</code> files in all sub-directories of the <code>sass</code> folder, lints them with <a href="https://github.com/sasstools/sass-lint">Sass Lint</a>, initializes a <a href="https://snugug.com/musings/debugging-sass-source-maps/">Source Map</a>, compiles it to CSS using <a href="http://sass-lang.com/">Sass</a> and <a href="https://github.com/sass-eyeglass/eyeglass">Eyeglass</a> (the Node replacement for Compass's extensions and asset pipeline from Ruby), adds vendor prefixes to CSS via <a href="https://github.com/postcss/autoprefixer">Autoprefixer</a>, closes out the Source Map, and writes the compiled CSS file to the <code>./css</code> directory (with Source Map written to <code>./css/maps</code>).</p><p>Breaking down this task, <code>gulp.src</code> and <code>gulp.dest</code> under the hood are really the <a href="https://github.com/gulpjs/vinyl-fs">file stream Vinyl adapter</a>, <a href="https://github.com/gulpjs/vinyl">Vinyl</a> being a virtual file format. There are lots of different <a href="https://www.npmjs.com/search?q=vinyl-">Vinyl adapters</a>. Vinyl adapters take in a source (<code>src</code>) glob producing a stream of Vinyl objects. With this knowledge, we can rethink how we build our Gulp tasks to make them more testable!</p><p>Accepting that <code>gulp.src</code> and the final pipe, <code>gulp.dest</code>, we shouldn't <em>need</em> to test, as they are already tested in Gulp (and again in Vinyl FS), then the only thing we need to test is the middle bit; that our transforms work the way we expect them to. So, let's break that middle bit out!</p><p>Turns out, there's a <em>great</em> Node module for this already called <a href="https://www.npmjs.com/package/lazypipe">lazypipe</a>. Lazypipe allows us to build a reusable set of pipes, that we can call from a pipe. This is going to be the key to modularizing our Gulp task, and eventually testing it. Let's break that previous Gulp task out in t a <code>lib</code> file that an be reused, and the task itself:</p><p><strong>lib/sass.js</strong></p><pre class="language-javascript"><code class="language-javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> lazypipe <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'lazypipe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> sass <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-sass'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> eyeglass <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'eyeglass'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> prefix <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-autoprefixer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> lint <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-sass-lint'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> maps <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-sourcemaps'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">lazypipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>lint<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>maps<span class="token punctuation">.</span>init<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>sass<span class="token punctuation">,</span> <span class="token function">eyeglass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>maps<span class="token punctuation">.</span>write<span class="token punctuation">,</span> <span class="token string">'./maps'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>Gulpfile.js</strong></p><pre class="language-javascript"><code class="language-javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> gulp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> sass <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./lib/sass'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'sass'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> gulp<span class="token punctuation">.</span><span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'sass/**/*.scss'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">sass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'./css'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>Now we have two files: <code>lib/sass.js</code> that contains the <em>functionality</em> of the Gulp task, and <code>Gulpfile.js</code> which contains the <em>implementation</em> of the Gulp task. Now that there's a separation of concerns built, we are all set up to start testing.</p><h2>Testing Our Task</h2><p>Now that the body of our task is split out, we can start to test it! Because what we've got now in <code>lib/sass.js</code> is a reusable set of pipes that can be reused with <em>any</em> stream of Vinyl objects, we can build some test scaffolding around it! We can use Vinyl FS like what's under the hood for Gulp, or wen can use <a href="https://www.npmjs.com/package/vinyl-string">Vinyl String</a> to build a stream of Vinyl Objects (well, really, one object) from a string. I've also found that wrapping our stream in a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promise</a> makes it easier to plug in to any test system out there, so let's do that as well.</p><p><strong>tests/helpers/pipe.js</strong></p><pre class="language-javascript"><code class="language-javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> vs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vinyl-string'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'map-stream'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Lets us write in-line functions in our pipe</span>

<span class="token comment">/*
 * Get transformed contents of a string
 *
 * @param {string} input - String contents of the "file"
 * @param {string} path  - The "path" of the "file"
 * @param {function} func - The lazypipe that will be used to transform the input
 *
 * @returns {string} Vinyl file representing the original `input` and `path`, transformed by the `func`
 */</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">fromString</span> <span class="token operator">=</span> <span class="token punctuation">(</span>input<span class="token punctuation">,</span> path<span class="token punctuation">,</span> func<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> rej<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> contents <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// So we can grab the content later</span>

    <span class="token keyword">const</span> vFile <span class="token operator">=</span> <span class="token function">vs</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> <span class="token punctuation">{</span> path <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Equivalent to path: path. ES6 Object Literal Shorthand Syntax</span>

    vFile
      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// Call the function we're going to pass in</span>
      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        contents <span class="token operator">=</span> file<span class="token punctuation">;</span>
        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> e <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">rej</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">res</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>The <code>fromString</code> function takes a string to transform, what its file path would be (if it had been a file), and the lazypipe function, and it'll return a promise that will reject if there's an error, or resolve with the Vinyl file. Once we have this, we're all set up to test our task! This example is going to be with <a href="https://github.com/avajs/ava">AVA</a>, but will work with any test scaffolding.</p><p><strong>tests/sass.js</strong></p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">import</span> test <span class="token keyword">from</span> <span class="token string">'ava'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>fromString<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./helpers/pipe'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> sass <span class="token keyword">from</span> <span class="token string">'../lib/sass'</span><span class="token punctuation">;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'compiles'</span><span class="token punctuation">,</span> t <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> input <span class="token operator">=</span> <span class="token string">'$foo: red; body { background: $foo; }'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> expected <span class="token operator">=</span> <span class="token string">'body{background:red}\n\n/*# sourceMappingURL=../maps/sass/style.css.map */\n'</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">fromString</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> <span class="token string">'sass/style.scss'</span><span class="token punctuation">,</span> sass<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>output <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> contents <span class="token operator">=</span> output<span class="token punctuation">.</span>contents<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      t<span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span>contents<span class="token punctuation">,</span> expected<span class="token punctuation">,</span> <span class="token string">'Sass compiled as expected'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>And with that, we've been able to divide out the body of a Gulp task to make it both modular and testable! This can be seen in action in the (as of this writing) <a href="https://github.com/snugug/gulp-armadillo/tree/3.x">3.x Armadillo branch</a> (or in the <code>master</code> branch if I've finished it all by then).</p><p>Happy testing!</p></div><footer class="article--author"><span class="article--published" itemprop="datePublished">Published on <time datetime="2018-07-29">December 17th, 2016</time></span></footer></article></main><footer class="_blog--footer"><div class="footer"><ul class="footer--links"><li class="footer--link-item"><a href="/" class="footer--link">Home</a></li><li class="footer--link-item"><a href="/me/" class="footer--link">Me</a></li><li class="footer--link-item"><a href="/presentations/" class="footer--link">Presentations</a></li><li class="footer--link-item"><a href="/musings/" class="footer--link">Musings</a></li></ul></div></footer></div><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-30577396-1', 'auto');
    ga('send', 'pageview');</script></body></html>